name: Deploy Django

# Só roda quando um PR é fechado no branch main
on:
  pull_request:
    branches:
      - main
    types:
      - closed

jobs:
  deploy:
  # Só roda se além do PR fechado, também houve um merge.
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy code via rsync
      run: |
        rsync -az --delete \
          --exclude=".git" \
          --exclude=".github" \
          --exclude=".env" \
          ./ ${{ secrets.SERVER }}:${{ secrets.LOCATION }}

    - name: Restart Docker Compose
      run: |
        ssh ${{ secrets.SERVER }} << 'EOF'
        cd ${{ secrets.LOCATION }}
        docker compose pull || true
        docker compose build --no-cache
        docker compose up -d
        docker image prune -f
        EOF
